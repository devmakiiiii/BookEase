// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      UserRole   @default(CUSTOMER)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  bookings  Booking[]
  admin     Admin?
}

model Admin {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

enum UserRole {
  CUSTOMER
  ADMIN
}

model Service {
  id                          String   @id @default(cuid())
  name                        String
  description                 String
  duration                    Int      // in minutes
  price                       Int      // in cents
  isActive                    Boolean  @default(true)
  cancellationHoursBefore     Int      @default(24) // hours before appointment when cancellation is allowed
  cancellationFeePercentage   Int      @default(0)  // percentage of service price charged as fee
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  bookings Booking[]
}

model Booking {
   id                    String            @id @default(cuid())
   customerId            String
   customer              User              @relation(fields: [customerId], references: [id], onDelete: Cascade)
   serviceId             String
   service               Service           @relation(fields: [serviceId], references: [id])
   startTime             DateTime
   endTime               DateTime
   status                BookingStatus     @default(PENDING)
   paymentStatus         PaymentStatus     @default(UNPAID)
   stripeSessionId       String?
   stripeRefundId        String?
   notes                 String?
   cancelledBy           String?
   cancelledAt           DateTime?
   cancellationReason    CancellationReason?
   refundAmount          Int?              // in cents
   completedAt           DateTime?
   createdAt             DateTime          @default(now())
   updatedAt             DateTime          @updatedAt

   @@index([customerId])
   @@index([serviceId])
   @@index([startTime])
   @@index([status])
   @@index([cancelledAt])
   @@index([completedAt])
 }

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  FAILED
  REFUNDED
}

enum CancellationReason {
  CUSTOMER_REQUEST
  ADMIN_CANCELLED
  NO_SHOW
  TECHNICAL_ISSUE
  OTHER
}
